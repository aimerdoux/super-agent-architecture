name: Super Agent Self-Deploy

on:
  push:
    branches: [main]
    paths:
      - '**.ts'
      - '**.js'
      - '**.json'
      - 'supabase/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - deploy-functions
          - restart-agent
          - check-status
          - run-tests

env:
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  # ==========================================
  # JOB 1: LINT & TEST
  # ==========================================
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || echo "No lint script configured"

      - name: Run tests
        run: npm test || echo "No tests configured"

      - name: Report status
        if: always()
        run: |
          echo "âœ… Lint and test completed"
          echo "ğŸ“Š Status: ${{ job.status }}"

  # ==========================================
  # JOB 2: DEPLOY EDGE FUNCTIONS
  # ==========================================
  deploy-functions:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Login to Supabase
        run: |
          echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | supabase login

      - name: Link project
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Deploy Edge Functions
        run: |
          echo "ğŸš€ Deploying self-upgrade function..."
          supabase functions deploy self-upgrade --no-verify-jwt --project-ref ${{ env.SUPABASE_PROJECT_REF }}
          
          echo "ğŸš€ Deploying agent-core function..."
          supabase functions deploy agent-core --no-verify-jwt --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Verify deployment
        run: |
          echo "âœ… Edge Functions deployed"
          supabase functions list --project-ref ${{ env.SUPABASE_PROJECT_REF }}

  # ==========================================
  # JOB 3: DEPLOY DATABASE SCHEMA
  # ==========================================
  deploy-database:
    name: Deploy Database Schema
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link project
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Push database migrations
        run: |
          echo "ğŸš€ Deploying database schema..."
          supabase db push --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Verify schema
        run: |
          echo "âœ… Database schema deployed"
          supabase db diff --project-ref ${{ env.SUPABASE_PROJECT_REF }}

  # ==========================================
  # JOB 4: RESTART AGENT (Optional)
  # ==========================================
  restart-agent:
    name: Restart Agent
    runs-on: ubuntu-latest
    needs: [deploy-functions, deploy-database]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'restart-agent'
    
    steps:
      - name: Trigger agent restart
        run: |
          echo "ğŸ”„ Triggering agent restart..."
          
          RESPONSE=$(curl -s -X POST "https://${{ env.SUPABASE_PROJECT_REF }}.functions.supabase.co/agent-core" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"action": "restart"}')
          
          echo "Response: $RESPONSE"
          echo "âœ… Agent restart triggered"

      - name: Wait and verify
        run: |
          sleep 10
          
          STATUS=$(curl -s "https://${{ env.SUPABASE_PROJECT_REF }}.functions.supabase.co/agent-core" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"action": "status"}' | jq -r '.agent.status')
          
          echo "Agent status: $STATUS"
          
          if [ "$STATUS" == "running" ]; then
            echo "âœ… Agent is running"
          else
            echo "âš ï¸ Agent status: $STATUS"
          fi

  # ==========================================
  # JOB 5: CHECK STATUS
  # ==========================================
  check-status:
    name: Check Agent Status
    runs-on: ubuntu-latest
    needs: [deploy-functions, deploy-database]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'check-status'
    
    steps:
      - name: Get agent status
        run: |
          echo "ğŸ” Checking agent status..."
          
          STATUS=$(curl -s "https://${{ env.SUPABASE_PROJECT_REF }}.functions.supabase.co/agent-core" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"action": "status"}')
          
          echo "Agent Status:"
          echo "$STATUS" | jq .
          
          # Also check upgrade endpoint
          UPGRADE_STATUS=$(curl -s "https://${{ env.SUPABASE_PROJECT_REF }}.functions.supabase.co/self-upgrade" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"action": "health"}')
          
          echo -e "\nUpgrade System Health:"
          echo "$UPGRADE_STATUS" | jq .

  # ==========================================
  # JOB 6: UPDATE AGENT VERSION
  # ==========================================
  update-version:
    name: Update Agent Version
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Get latest commit info
        id: commit
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Update agent version in database
        run: |
          echo "ğŸ“ Updating agent version to ${{ steps.commit.outputs.sha }}"
          
          # Use Supabase CLI to execute SQL
          supabase db execute --project-ref ${{ env.SUPABASE_PROJECT_REF }} << EOF
            UPDATE agent_state 
            SET version = '${{ steps.commit.outputs.sha }}',
                commit_sha = '${{ steps.commit.outputs.sha }}',
                last_updated = NOW()
            WHERE agent_name = 'super-agent';
            
            INSERT INTO upgrade_history 
              (from_version, to_version, commit_sha, changelog, status)
            SELECT 
              version,
              '${{ steps.commit.outputs.sha }}',
              '${{ steps.commit.outputs.sha }}',
              '${{ steps.commit.outputs.message }}',
              'success'
            FROM agent_state 
            WHERE agent_name = 'super-agent';
          EOF
          
          echo "âœ… Version updated in database"

      - name: Log upgrade
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: '${{ steps.commit.outputs.sha }}',
              body: 'ğŸ¤– Auto-upgrade deployed via GitHub Actions\\n\\n**Author:** ${{ steps.commit.outputs.author }}'
            })

  # ==========================================
  # NOTIFICATION
  # ==========================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-functions, deploy-database, update-version]
    if: always() && github.event_name == 'push'
    
    steps:
      - name: Prepare notification
        id: notification
        run: |
          if [ "${{ needs.deploy-functions.result }}" == "success" ] && \
             [ "${{ needs.deploy-database.result }}" == "success" ] && \
             [ "${{ needs.update-version.result }}" == "success" ]; then
            echo "status=âœ… Deployment Successful" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ Deployment Failed" >> $GITHUB_OUTPUT
            echo "color=error" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo ""
          echo "========================================"
          echo "ğŸš€ SUPER AGENT DEPLOYMENT COMPLETE"
          echo "========================================"
          echo "ğŸ“¦ Functions: ${{ needs.deploy-functions.result }}"
          echo "ğŸ—„ï¸  Database: ${{ needs.deploy-database.result }}"
          echo "ğŸ“ Version:   ${{ needs.update-version.result }}"
          echo "========================================"
