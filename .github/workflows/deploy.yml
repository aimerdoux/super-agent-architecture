name: Super Agent Self-Deploy

on:
  push:
    branches: [main]
    paths:
      - '**.ts'
      - '**.js'
      - '**.json'
      - 'supabase/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - deploy-functions
          - restart-agent
          - check-status
          - run-tests

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  # ==========================================
  # JOB 1: LINT & TEST
  # ==========================================
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ] || [ -f "yarn.lock" ]; then
            npm ci
          else
            echo "No lock file found, skipping npm install"
          fi

      - name: Run linter
        run: npm run lint 2>/dev/null || echo "No lint script configured"

      - name: Run tests
        run: npm test 2>/dev/null || echo "No tests configured"

  # ==========================================
  # JOB 2: DEPLOY EDGE FUNCTIONS
  # ==========================================
  deploy-functions:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest
    needs: [lint-and-test]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link project
        run: supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Deploy Edge Functions
        run: |
          supabase functions deploy self-upgrade --no-verify-jwt
          supabase functions deploy agent-core --no-verify-jwt

      - name: Set function secrets
        run: |
          supabase secrets set \
            GITHUB_TOKEN="${{ secrets.GH_PAT_TOKEN }}" \
            SUPABASE_URL="$SUPABASE_URL" \
            SUPABASE_SERVICE_ROLE_KEY="$SUPABASE_SERVICE_KEY"

      - name: Verify deployment
        run: supabase functions list

  # ==========================================
  # JOB 3: DEPLOY DATABASE SCHEMA
  # ==========================================
  deploy-database:
    name: Deploy Database Schema
    runs-on: ubuntu-latest
    needs: [lint-and-test]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link project
        run: supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Push database migrations
        run: supabase db push || echo "No pending migrations"

  # ==========================================
  # JOB 4: POST-DEPLOY VERIFICATION
  # ==========================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-functions]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Health check agent-core
        run: |
          RESPONSE=$(curl -sf -X POST \
            "${SUPABASE_URL}/functions/v1/agent-core" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"action": "status"}') || true
          echo "Agent Core: $RESPONSE"

      - name: Notify self-upgrade
        run: |
          curl -sf -X POST \
            "${SUPABASE_URL}/functions/v1/self-upgrade" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"action\": \"pull\", \"commit_sha\": \"${{ github.sha }}\"}" || true

  # ==========================================
  # JOB 5: RESTART AGENT (Manual only)
  # ==========================================
  restart-agent:
    name: Restart Agent
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'restart-agent'

    steps:
      - name: Trigger agent restart
        run: |
          curl -sf -X POST \
            "${SUPABASE_URL}/functions/v1/agent-core" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"action": "restart"}'

  # ==========================================
  # JOB 6: CHECK STATUS (Manual only)
  # ==========================================
  check-status:
    name: Check Agent Status
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'check-status'

    steps:
      - name: Get agent status
        run: |
          curl -sf -X POST \
            "${SUPABASE_URL}/functions/v1/agent-core" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"action": "status"}' | jq .
