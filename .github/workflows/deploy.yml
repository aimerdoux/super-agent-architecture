name: Super Agent Self-Deploy

concurrency:
  group: super-agent-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - '**.ts'
      - '**.js'
      - '**.json'
      - 'supabase/**'
      - '.github/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - deploy-functions
          - restart-agent
          - check-status

permissions:
  contents: read
  actions: write

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  validate-secrets:
    name: Validate Secrets
    runs-on: self-hosted
    timeout-minutes: 2
    steps:
      - name: Check required secrets
        run: |
          MISSING=""
          [ -z "${{ secrets.SUPABASE_URL }}" ] && MISSING="$MISSING SUPABASE_URL"
          [ -z "${{ secrets.SUPABASE_SERVICE_KEY }}" ] && MISSING="$MISSING SUPABASE_SERVICE_KEY"
          [ -z "${{ secrets.SUPABASE_PROJECT_REF }}" ] && MISSING="$MISSING SUPABASE_PROJECT_REF"
          [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ] && MISSING="$MISSING SUPABASE_ACCESS_TOKEN"
          [ -n "$MISSING" ] && echo "::error::Missing secrets:$MISSING" && echo "::error::Add them at: Repo Settings > Secrets and variables > Actions" && exit 1
          echo "All required secrets present"

  lint-and-test:
    name: Lint & Test
    runs-on: self-hosted
    needs: [validate-secrets]
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install and test
        run: |
          if [ -f "package-lock.json" ] || [ -f "yarn.lock" ]; then
            npm ci
          else
            echo "No lock file, skipping install"
          fi
          npm run lint 2>/dev/null || echo "No lint configured"
          npm test 2>/dev/null || echo "No tests configured"

  deploy-functions:
    name: Deploy Edge Functions
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [lint-and-test]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          GH_PAT: ${{ secrets.GH_PAT_TOKEN }}
        run: |
          [ -z "$GH_PAT" ] && echo "::error::GH_PAT_TOKEN secret required for deploy" && exit 1
          supabase link --project-ref "$SUPABASE_PROJECT_REF"
          supabase functions deploy self-upgrade --no-verify-jwt
          supabase functions deploy agent-core --no-verify-jwt
          supabase secrets set \
            GITHUB_TOKEN="$GH_PAT" \
            SUPABASE_URL="$SUPABASE_URL" \
            SUPABASE_SERVICE_ROLE_KEY="$SUPABASE_SERVICE_KEY"
          supabase functions list

  deploy-database:
    name: Deploy Database
    runs-on: self-hosted
    timeout-minutes: 10
    needs: [lint-and-test]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy schema
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase link --project-ref "$SUPABASE_PROJECT_REF"
          supabase db push || echo "No pending migrations"

  verify:
    name: Verify
    runs-on: self-hosted
    timeout-minutes: 5
    needs: [deploy-functions]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Health check and notify
        run: |
          curl -sf -X POST "${SUPABASE_URL}/functions/v1/agent-core" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"action": "status"}' || echo "Health check pending"

          curl -sf -X POST "${SUPABASE_URL}/functions/v1/self-upgrade" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"action\": \"pull\", \"commit_sha\": \"${{ github.sha }}\"}" || true

  restart-agent:
    name: Restart Agent
    runs-on: self-hosted
    needs: [validate-secrets]
    timeout-minutes: 5
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'restart-agent'
    steps:
      - name: Restart
        run: |
          curl -sf -X POST "${SUPABASE_URL}/functions/v1/agent-core" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"action": "restart"}'

  check-status:
    name: Check Status
    runs-on: self-hosted
    needs: [validate-secrets]
    timeout-minutes: 5
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'check-status'
    steps:
      - name: Status
        run: |
          curl -sf -X POST "${SUPABASE_URL}/functions/v1/agent-core" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"action": "status"}' | jq .
