name: Super Agent Self-Deploy

on:
  push:
    branches: [main]
    paths:
      - '**.ts'
      - '**.js'
      - '**.json'
      - 'supabase/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - deploy-functions
          - restart-agent
          - check-status
          - run-tests

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

jobs:
  # ==========================================
  # JOB 1: LINT & TEST
  # ==========================================
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'none'

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ] || [ -f "npm-shrinkwrap.json" ] || [ -f "yarn.lock" ]; then
            npm ci
          else
            echo "No lock file found, skipping npm install"
          fi

      - name: Run linter
        run: npm run lint 2>/dev/null || echo "No lint script configured"

      - name: Run tests
        run: npm test 2>/dev/null || echo "No tests configured"

      - name: Report status
        if: always()
        run: |
          echo "Lint and test completed"
          echo "Status: ${{ job.status }}"

  # ==========================================
  # JOB 2: DEPLOY EDGE FUNCTIONS
  # ==========================================
  deploy-functions:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Extract project ref from URL
        run: |
          echo "SUPABASE_PROJECT_REF=${SUPABASE_URL##*/}" >> $GITHUB_ENV
          echo "Project ref: ${{ env.SUPABASE_PROJECT_REF }}"

      - name: Login to Supabase
        run: |
          echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | supabase login

      - name: Link project
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Deploy Edge Functions
        run: |
          echo "Deploying self-upgrade function..."
          supabase functions deploy self-upgrade --no-verify-jwt --project-ref ${{ env.SUPABASE_PROJECT_REF }}
          
          echo "Deploying agent-core function..."
          supabase functions deploy agent-core --no-verify-jwt --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Verify deployment
        run: |
          echo "Edge Functions deployed"
          supabase functions list --project-ref ${{ env.SUPABASE_PROJECT_REF }}

  # ==========================================
  # JOB 3: DEPLOY DATABASE SCHEMA
  # ==========================================
  deploy-database:
    name: Deploy Database Schema
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Extract project ref from URL
        run: |
          echo "SUPABASE_PROJECT_REF=${SUPABASE_URL##*/}" >> $GITHUB_ENV

      - name: Link project
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Push database migrations
        run: |
          echo "Deploying database schema..."
          supabase db push --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Verify schema
        run: |
          echo "Database schema deployed"
          supabase db diff --project-ref ${{ env.SUPABASE_PROJECT_REF }}

  # ==========================================
  # JOB 4: RESTART AGENT (Optional)
  # ==========================================
  restart-agent:
    name: Restart Agent
    runs-on: ubuntu-latest
    needs: [deploy-functions, deploy-database]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'restart-agent'
    
    steps:
      - name: Trigger agent restart
        run: |
          echo "Triggering agent restart..."
          
          RESPONSE=$(curl -s -X POST "https://${{ env.SUPABASE_PROJECT_REF }}.functions.supabase.co/agent-core" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"action": "restart"}')
          
          echo "Response: $RESPONSE"
          echo "Agent restart triggered"

      - name: Wait and verify
        run: |
          sleep 10
          
          STATUS=$(curl -s "https://${{ env.SUPABASE_PROJECT_REF }}.functions.supabase.co/agent-core" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"action": "status"}' | jq -r '.agent.status')
          
          echo "Agent status: $STATUS"

  # ==========================================
  # JOB 5: CHECK STATUS
  # ==========================================
  check-status:
    name: Check Agent Status
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'check-status'
    
    steps:
      - name: Extract project ref
        run: |
          echo "SUPABASE_PROJECT_REF=${SUPABASE_URL##*/}" >> $GITHUB_ENV

      - name: Get agent status
        run: |
          echo "Checking agent status..."
          
          STATUS=$(curl -s "https://${{ env.SUPABASE_PROJECT_REF }}.functions.supabase.co/agent-core" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"action": "status"}')
          
          echo "Agent Status:"
          echo "$STATUS" | jq .

  # ==========================================
  # NOTIFICATION
  # ==========================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-functions, deploy-database]
    if: always() && github.event_name == 'push'
    
    steps:
      - name: Summary
        run: |
          echo ""
          echo "========================================"
          echo "SUPER AGENT DEPLOYMENT COMPLETE"
          echo "========================================"
          echo "Functions: ${{ needs.deploy-functions.result }}"
          echo "Database: ${{ needs.deploy-database.result }}"
          echo "========================================"
